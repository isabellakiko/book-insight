# 人物分析数据不完整问题 - 深度排查与修复计划

> **状态**: 待执行 | **优先级**: P0 | **预计工作量**: 中等
> **发现日期**: 2025-12-11 晚 | **目标完成**: 2025-12-12
> **排查人**: Claude Code + 用户协作

---

## 零、今日开发概览 (2025-12-11)

### 时间线

| 时间 | 工作内容 | 状态 |
|------|---------|------|
| 下午 | 人物详情页 CharacterDetail V2 双栏布局重构 | ✅ 完成 |
| 下午 | CSS 样式大规模重写（cdv2-* 前缀） | ✅ 完成 |
| 傍晚 | 用户反馈"页面很不好看" | - |
| 傍晚 | CSS 类名不匹配问题修复（JSX vs CSS） | ✅ 完成 |
| 傍晚 | 用户反馈"为什么这么多空白" | - |
| 傍晚 | 修复 .cdv2-tab-content max-width 问题 | ✅ 完成 |
| 晚间 | 用户反馈"概况为什么只有前200多章" | - |
| 晚间 | 全面排查数据完整性问题 | ✅ 完成 |
| 晚间 | 制定修复计划并更新文档 | ✅ 完成 |

### 今日完成的工作

#### 1. CharacterDetail V2 双栏布局重构

**需求背景**: 用户认为原来的人物详情页"太古老"，要求重新设计

**新布局结构**:
```
┌─────────────────────────────────────────────────────┐
│ 移动端顶栏（仅移动端显示）                            │
├──────────────────┬──────────────────────────────────┤
│                  │                                  │
│  左侧边栏        │       右侧内容区                   │
│  (固定 280px)    │       (flex: 1)                  │
│                  │                                  │
│  ┌────────────┐  │  ┌────────────────────────────┐  │
│  │ 人物档案   │  │  │ Tab 内容                    │  │
│  │ - 名称     │  │  │ - 概览                      │  │
│  │ - 别名     │  │  │ - 成长                      │  │
│  │ - 简介     │  │  │ - 性格                      │  │
│  │ - 统计     │  │  │ - 光影                      │  │
│  ├────────────┤  │  │ - 语录                      │  │
│  │ 目录导航   │  │  │ - 关系                      │  │
│  │ (7个Tab)   │  │  │ - 关联人物                   │  │
│  ├────────────┤  │  │ - 章节足迹                   │  │
│  │ 页脚       │  │  └────────────────────────────┘  │
│  └────────────┘  │                                  │
│                  │                                  │
└──────────────────┴──────────────────────────────────┘
```

**CSS 命名规范**: 全部使用 `cdv2-*` 前缀（Character Detail V2）

**文件修改**:
- `apps/web/src/pages/CharacterDetail.jsx` - 约 800 行，完全重写
- `apps/web/src/index.css` - 新增 ~1200 行 cdv2-* 样式

#### 2. CSS 样式修复

**问题 1**: 用户反馈"页面很不好看，只是展示了内容"

**原因**: JSX 中的类名与 CSS 中的类名不匹配

**修复过程**:
1. 提取 JSX 中所有 cdv2-* 类名（117 个）
2. 提取 CSS 中所有 cdv2-* 类名
3. 对比发现大量缺失
4. 逐一补充缺失的样式

**问题 2**: 用户反馈"为什么这么多空白"

**原因**: `.cdv2-tab-content` 设置了 `max-width: 900px` 但没居中

**修复**: 改为 `width: 100%` 让内容铺满

#### 3. 数据完整性问题发现

**用户反馈**:
> "概况为什么只有前200多章的？成长也是，只有300多章。性格是不是也是？感觉有很大问题。是没有数据，还是前端没展示？"

**排查方式**: 启动 3 个 Explore Agent 并行调查
1. Agent 1: 后端数据生成逻辑
2. Agent 2: 数据存储和 API 返回
3. Agent 3: 前端展示逻辑

**核心结论**: **是后端没有生成完整数据，不是前端没展示**

### 今日更新的文档

| 文档 | 更新内容 |
|------|---------|
| `docs/ai-context/CURRENT.md` | 添加 Day 5 问题发现记录、更新本周任务 |
| `docs/ai-context/CONTEXT.md` | 更新"已知限制"部分 |
| `docs/development/api/character-analysis.md` | 添加分析参数配置表、代码位置表 |
| `docs/development/api/routers.md` | 添加 max_chapters 参数说明和警告 |
| `docs/深度排查/数据完整性修复计划-2025-12-12.md` | 本文档 |

### 今日未提交的代码变更

```bash
# 查看当前变更
git status
# 结果：
# M apps/api/src/ai/client.py
# M apps/api/src/ai/tasks/character_analyzer.py
# M apps/api/src/knowledge/models.py
# M apps/web/src/index.css
# M apps/web/src/pages/CharacterDetail.jsx
```

**变更说明**:
- `index.css` - cdv2-* 样式大规模重写
- `CharacterDetail.jsx` - V2 双栏布局重构
- 其他文件 - 之前的开发变更

---

## 一、问题诊断结果

### 核心结论

**是后端没有生成完整数据，不是前端没展示**

用户反馈：
- 概况只有前 200 多章的内容
- 成长历程只有 300 多章
- 性格分析可能也有类似问题

### 数据截断链路（完整追踪）

```
第一步：用户请求分析人物"赵秦"
         ↓
第二步：搜索人物出现章节
         → CharacterSearchResult: found_in_chapters = [168, 169, ..., 8095]
         → 共 1112 章 ✓ 搜索正常
         ↓
第三步：智能采样（问题开始）
         → _smart_sample_chapters(found_chapters=1112, max_chapters=30)
         → 均匀采样 30 章：[168, 438, 708, ..., 8095]
         → 丢失 1082 章的数据 ✗
         ↓
第四步：逐章分析（只分析 30 章）
         → 生成 30 个 CharacterAppearance
         → 每章提取：events, interactions, quote, emotional_state
         ↓
第五步：汇总分析（基于 30 章的数据）
         ├─ analyze_growth_phases(): timeline_data[:60] → 实际只有 30 条
         ├─ extract_quotes(): quotes_raw[:40] → 最终 [:25]
         ├─ analyze_relations(): top 10 人物，每人 [:8] 互动
         ├─ analyze_personality(): [:25] 事件 + [:8] 台词
         └─ analyze_deep_profile(): [:8] 定义性时刻
         ↓
第六步：保存到 profile.json
         → 数据不完整但格式正确
         ↓
第七步：前端展示
         → 完整显示 profile.json 中的数据
         → 前端无截断 ✓
```

### 为什么用户看到"前 200 多章"

虽然采样是均匀的（覆盖 168~8095 章范围），但：

1. **成长阶段分析**: AI 生成的 growth_phases 是基于 30 个采样章节推断的
2. **概况总结**: character_arc_summary 基于有限样本生成
3. **具体章节数据**: appearances 数组只有 30 条记录

用户看到的"前 200 多章"可能是因为：
- 概况中的叙述主要基于早期章节的样本
- 成长阶段的第一阶段恰好覆盖 ~200 章

---

## 二、问题根源详解

### 2.1 API 默认参数限制（最严重）

**文件**: `apps/api/src/routers/analysis.py`
**行号**: 36-40

```python
class CharacterAnalyzeRequest(BaseModel):
    """Request to analyze character."""
    name: str
    max_chapters: int = 30  # ← 问题根源！
```

**调用链路**:
```
前端 useCharacterAnalysis.js
  → GET /api/analysis/{book_id}/characters/stream?name=赵秦
    → analyze_character_stream()
      → analyzer.analyze_full(book, name, max_chapters=30)  # 默认值
        → _smart_sample_chapters(found_chapters, 30)
          → 只选 30 章
```

**影响**: 即使人物出现 1112 章，初始分析只会均匀采样 30 章

### 2.2 智能采样算法

**文件**: `apps/api/src/ai/tasks/character_analyzer.py`
**行号**: 55-89

```python
def _smart_sample_chapters(
    self, found_chapters: list[int], max_chapters: int
) -> list[int]:
    """智能采样章节，覆盖人物出现的全部范围。

    采样策略：
    - 如果章节数 <= max_chapters，返回全部
    - 否则均匀采样，确保覆盖开头、中间、结尾
    """
    total = len(found_chapters)
    if total <= max_chapters:
        return found_chapters

    # 均匀采样
    step = total / max_chapters
    sampled_indices = set()

    # 确保包含首尾
    sampled_indices.add(0)
    sampled_indices.add(total - 1)

    # 均匀选取中间章节
    for i in range(max_chapters - 2):
        idx = int((i + 1) * step)
        if idx < total:
            sampled_indices.add(idx)

    # 转换回章节索引
    sorted_indices = sorted(sampled_indices)
    return [found_chapters[i] for i in sorted_indices]
```

**问题**:
- 均匀采样会跳过大量中间章节
- 重要情节可能被跳过
- 人物关系发展的细节丢失

### 2.3 各分析模块硬编码限制

#### 成长阶段分析
**文件**: `character_analyzer.py:235`
```python
for i, entry in enumerate(timeline_data[:60]):  # 最多 60 章
```

#### 语录提取
**文件**: `character_analyzer.py:348, 405`
```python
# 第 348 行：原始提取
quotes_text = "\n".join([... for q in quotes_raw[:40]])

# 第 405 行：最终返回
for q in result.get("quotes", [])[:25]:
```

#### 人物关系分析
**文件**: `character_analyzer.py:451, 453`
```python
# 第 451 行：只分析前 10 个重要人物
for char, interactions in sorted(...)[:10]:

# 第 453 行：每人只展示 8 次互动
for i in interactions[:8]:
```

#### 性格分析
**文件**: `character_analyzer.py:641, 644`
```python
# 第 641 行：事件限制
{chr(10).join(events_summary[:25])}

# 第 644 行：台词限制
{chr(10).join(quotes[:8]) if quotes else "（暂无记录）"}
```

#### 定义性时刻
**文件**: `character_analyzer.py:854`
```python
for dm in result.get("defining_moments", [])[:8]:
```

### 2.4 前端展示问题（轻微）

**文件**: `apps/web/src/pages/CharacterDetail.jsx`
**行号**: 约 292

```jsx
// 性格特征证据只显示第一条
{Array.isArray(trait.evidence) ? trait.evidence[0] : trait.evidence}
```

**影响**: 即使后端返回多条证据，前端只显示第一条

### 2.5 完整的限制汇总表

| 限制点 | 代码位置 | 当前值 | 影响 |
|--------|---------|-------|------|
| API 默认采样 | analysis.py:39 | 30 章 | 只分析 30 章 |
| 成长阶段展示 | character_analyzer.py:235 | [:60] | 最多 60 章给 AI |
| 语录原始提取 | character_analyzer.py:348 | [:40] | 最多 40 条原始 |
| 语录最终返回 | character_analyzer.py:405 | [:25] | 最多 25 条结果 |
| 关系人物数 | character_analyzer.py:451 | [:10] | 只分析 10 人 |
| 每人互动数 | character_analyzer.py:453 | [:8] | 每人 8 次互动 |
| 性格事件数 | character_analyzer.py:641 | [:25] | 25 个事件 |
| 性格台词数 | character_analyzer.py:644 | [:8] | 8 条台词 |
| 定义性时刻 | character_analyzer.py:854 | [:8] | 8 个时刻 |
| 前端证据 | CharacterDetail.jsx:292 | [0] | 只显示第一条 |

---

## 三、修复方案

### 推荐方案：组合式修复

综合考虑数据完整性、API 成本、开发复杂度，采用以下组合：

1. **提高采样上限**（简单快速）- P0
2. **优化各模块限制**（配合采样增加）- P0
3. **前端证据完整显示**（体验优化）- P1

### 3.1 后端修改

#### 3.1.1 提高 max_chapters 默认值

**文件**: `apps/api/src/routers/analysis.py`
**修改位置**: 第 39 行

```python
# 修改前
class CharacterAnalyzeRequest(BaseModel):
    name: str
    max_chapters: int = 30

# 修改后
class CharacterAnalyzeRequest(BaseModel):
    name: str
    max_chapters: int = 100  # 提升到 100
```

#### 3.1.2 提高各模块限制

**文件**: `apps/api/src/ai/tasks/character_analyzer.py`

| 修改点 | 原值 | 新值 | 行号 | 搜索关键词 |
|--------|------|------|------|-----------|
| 成长阶段展示 | 60 | 150 | 235 | `timeline_data[:60]` |
| 语录原始提取 | 40 | 80 | 348 | `quotes_raw[:40]` |
| 语录最终返回 | 25 | 50 | 405 | `[:25]` (在 quotes 循环中) |
| 关系人物数 | 10 | 20 | 451 | `[:10]` (在 sorted 后) |
| 每人互动数 | 8 | 15 | 453 | `interactions[:8]` |
| 性格事件数 | 25 | 50 | 641 | `events_summary[:25]` |
| 性格台词数 | 8 | 15 | 644 | `quotes[:8]` |
| 定义性时刻 | 8 | 15 | 854 | `defining_moments", [])[:8]` |

#### 3.1.3 配置化（可选，推荐）

**文件**: `apps/api/src/config.py`

```python
# 在 Settings 类中新增
class Settings(BaseSettings):
    # ... 现有配置 ...

    # 人物分析配置
    character_max_chapters: int = 100
    character_max_growth_chapters: int = 150
    character_max_quotes_raw: int = 80
    character_max_quotes_final: int = 50
    character_max_relations: int = 20
    character_max_interactions: int = 15
    character_max_events: int = 50
    character_max_dialogues: int = 15
    character_max_moments: int = 15
```

然后在 `character_analyzer.py` 中使用 `settings.character_max_*` 替代硬编码值。

### 3.2 前端修改

**文件**: `apps/web/src/pages/CharacterDetail.jsx`
**修改位置**: 约第 292 行（性格特征渲染）

```jsx
// 修改前
<p className="cdv2-trait-evidence">
  <Sparkles size={12} />
  {Array.isArray(trait.evidence) ? trait.evidence[0] : trait.evidence}
</p>

// 修改后
<div className="cdv2-trait-evidence">
  <Sparkles size={12} />
  {Array.isArray(trait.evidence)
    ? trait.evidence.map((e, idx) => (
        <p key={idx} className="cdv2-trait-evidence-item">{e}</p>
      ))
    : <p>{trait.evidence}</p>
  }
</div>
```

**CSS 补充** (`index.css`):
```css
.cdv2-trait-evidence-item {
  margin: 0.25rem 0;
  padding-left: 0.5rem;
  border-left: 2px solid var(--border);
}

.cdv2-trait-evidence-item:first-child {
  margin-top: 0.5rem;
}
```

---

## 四、实施步骤（详细）

### Step 1: 后端参数调整

#### 1.1 修改 analysis.py

```bash
# 打开文件
code apps/api/src/routers/analysis.py

# 定位到第 39 行，修改 max_chapters 默认值
# 30 → 100
```

#### 1.2 修改 character_analyzer.py

```bash
# 打开文件
code apps/api/src/ai/tasks/character_analyzer.py

# 按顺序修改以下位置：
# 1. 第 235 行: timeline_data[:60] → timeline_data[:150]
# 2. 第 348 行: quotes_raw[:40] → quotes_raw[:80]
# 3. 第 405 行: [:25] → [:50]
# 4. 第 451 行: [:10] → [:20]
# 5. 第 453 行: [:8] → [:15]
# 6. 第 641 行: [:25] → [:50]
# 7. 第 644 行: [:8] → [:15]
# 8. 第 854 行: [:8] → [:15]
```

#### 1.3 (可选) 配置化

```bash
# 打开 config.py
code apps/api/src/config.py

# 添加配置项
# 然后在 character_analyzer.py 中引入使用
```

### Step 2: 前端优化

#### 2.1 修改证据显示

```bash
# 打开文件
code apps/web/src/pages/CharacterDetail.jsx

# 定位到性格特征渲染部分（约 292 行）
# 修改 evidence 显示逻辑
```

#### 2.2 添加 CSS

```bash
# 打开文件
code apps/web/src/index.css

# 添加 .cdv2-trait-evidence-item 样式
```

### Step 3: 数据重新分析

```bash
# 1. 确保后端正在运行
pnpm dev:api

# 2. 删除旧数据
rm -rf data/analysis/*/characters/赵秦

# 3. 重新分析（使用新参数，将自动使用 100 章）
python scripts/analyze.py 赵秦

# 或者指定更多章节
python scripts/analyze.py 赵秦 --chapters 200

# 4. 查看分析状态
python scripts/analyze.py 赵秦 --status
```

### Step 4: 验证

#### 4.1 验证后端数据

```bash
# 查看 profile.json 中的数据量
cat data/analysis/*/characters/赵秦/profile.json | python -c "
import json, sys
data = json.load(sys.stdin)
print(f'已分析章节: {data.get(\"total_analyzed_chapters\", 0)}')
print(f'appearances 数量: {len(data.get(\"appearances\", []))}')
print(f'growth_phases 数量: {len(data.get(\"growth_phases\", []))}')
print(f'quotes 数量: {len(data.get(\"quotes\", []))}')
print(f'relations 数量: {len(data.get(\"relations\", []))}')
print(f'core_traits 数量: {len(data.get(\"core_traits\", []))}')
"
```

#### 4.2 验证前端显示

```bash
# 启动前端
pnpm dev:web

# 访问人物详情页
open http://localhost:5173/characters/赵秦

# 检查各 Tab 的数据量
```

#### 4.3 构建验证

```bash
# 构建前端
pnpm --filter book-insight-web build

# 确保无错误
```

---

## 五、关键修改文件清单

| 文件 | 修改内容 | 优先级 | 预计行数 |
|------|---------|--------|---------|
| `apps/api/src/routers/analysis.py` | max_chapters 默认值 | P0 | 1 行 |
| `apps/api/src/ai/tasks/character_analyzer.py` | 8 处限制值 | P0 | 8 行 |
| `apps/api/src/config.py` | 新增配置项（可选） | P1 | ~15 行 |
| `apps/web/src/pages/CharacterDetail.jsx` | 证据完整显示 | P1 | ~10 行 |
| `apps/web/src/index.css` | 证据样式 | P1 | ~10 行 |

---

## 六、风险与注意事项

### 6.1 API 成本影响

| 方案 | 章节分析调用 | 汇总分析调用 | 总计 | 成本预估 |
|------|-------------|-------------|------|---------|
| 原方案 (30章) | 30 次 | ~5 次 | ~35 次 | 低 |
| 新方案 (100章) | 100 次 | ~5 次 | ~105 次 | 中 |
| 深度 (300章) | 300 次 | ~5 次 | ~305 次 | 中高 |
| 全量 (1112章) | 1112 次 | ~5 次 | ~1117 次 | 高 |

**建议**: 采用 100 章作为默认值，重要人物可手动指定更高值

### 6.2 分析时间影响

| 章节数 | 预计耗时 | 适用场景 |
|--------|---------|---------|
| 30 章 | 5-10 分钟 | 快速预览 |
| 100 章 | 15-25 分钟 | 日常分析（推荐默认） |
| 300 章 | 45-60 分钟 | 深度分析 |
| 全量 | 2-3 小时 | 核心主角完整分析 |

### 6.3 兼容性考虑

- 旧数据格式兼容：修改后的代码应能正常读取旧数据
- 增量分析兼容：`--continue` 模式应正常工作
- 前端兼容：即使后端返回更多数据，前端应能正常渲染

### 6.4 回滚方案

如果新参数导致问题：

```bash
# 1. 恢复代码
git checkout apps/api/src/routers/analysis.py
git checkout apps/api/src/ai/tasks/character_analyzer.py

# 2. 或手动指定旧参数
python scripts/analyze.py 赵秦 --chapters 30
```

---

## 七、验收标准

### 7.1 数据完整性

- [ ] `total_analyzed_chapters` >= 100（使用默认参数）
- [ ] `appearances` 数组长度 >= 100
- [ ] `growth_phases` 覆盖人物完整发展历程
- [ ] `quotes` 数量 >= 30（有足够语录的情况下）
- [ ] `relations` 包含主要关系人物

### 7.2 前端显示

- [ ] 概况 Tab 内容覆盖人物主要发展阶段
- [ ] 成长 Tab 显示完整成长轨迹
- [ ] 性格 Tab 每个特征显示所有证据（非仅第一条）
- [ ] 语录 Tab 显示更多经典语录
- [ ] 关系 Tab 显示更多人物关系
- [ ] 章节足迹显示正确的分析数量

### 7.3 系统稳定性

- [ ] 构建无错误
- [ ] 开发服务器正常运行
- [ ] API 响应正常
- [ ] 增量分析功能正常

---

## 八、执行检查清单

### 代码修改
- [ ] `analysis.py`: max_chapters 30 → 100
- [ ] `character_analyzer.py`: 成长阶段 60 → 150
- [ ] `character_analyzer.py`: 语录原始 40 → 80
- [ ] `character_analyzer.py`: 语录最终 25 → 50
- [ ] `character_analyzer.py`: 关系人物 10 → 20
- [ ] `character_analyzer.py`: 互动次数 8 → 15
- [ ] `character_analyzer.py`: 性格事件 25 → 50
- [ ] `character_analyzer.py`: 性格台词 8 → 15
- [ ] `character_analyzer.py`: 定义时刻 8 → 15
- [ ] `CharacterDetail.jsx`: 证据完整显示
- [ ] `index.css`: 证据样式

### 数据重建
- [ ] 停止后端服务
- [ ] 删除赵秦旧数据
- [ ] 重启后端服务
- [ ] 重新分析赵秦
- [ ] 验证数据量

### 文档同步
- [x] CURRENT.md: Day 5 问题发现记录
- [x] CONTEXT.md: 已知限制更新
- [x] character-analysis.md: 参数说明更新
- [x] routers.md: API 参数更新
- [x] 本文档: 完整修复计划

### 验证
- [ ] 概况覆盖范围
- [ ] 成长阶段完整
- [ ] 性格样本量
- [ ] 前端证据显示
- [ ] 构建通过
- [ ] 增量分析正常

---

## 九、相关文件索引

### 后端代码
- `apps/api/src/routers/analysis.py` - API 路由定义
- `apps/api/src/ai/tasks/character_analyzer.py` - 人物分析核心逻辑
- `apps/api/src/config.py` - 配置管理
- `apps/api/src/knowledge/models.py` - 数据模型定义

### 前端代码
- `apps/web/src/pages/CharacterDetail.jsx` - 人物详情页
- `apps/web/src/index.css` - 全局样式
- `apps/web/src/hooks/useCharacterAnalysis.js` - 分析状态管理

### 脚本
- `scripts/analyze.py` - 分析 CLI 工具
- `scripts/lib/api_client.py` - API 客户端

### 数据
- `data/analysis/{book_id}/characters/{name}/profile.json` - 人物分析结果

### 文档
- `docs/ai-context/CURRENT.md` - 开发日志
- `docs/ai-context/CONTEXT.md` - 项目上下文
- `docs/development/api/character-analysis.md` - 分析指南
- `docs/development/api/routers.md` - API 文档

---

## 十、明日开发恢复

### 快速恢复命令

```bash
# 1. 恢复项目上下文
/start

# 2. 查看本修复计划
cat docs/深度排查/数据完整性修复计划-2025-12-12.md

# 3. 开始执行修复
# 按照"第四节 实施步骤"依次执行
```

### 预计耗时

| 步骤 | 预计耗时 |
|------|---------|
| 代码修改 | 15-20 分钟 |
| 数据重新分析 | 20-30 分钟（100章） |
| 验证测试 | 10-15 分钟 |
| 文档收尾 | 5-10 分钟 |
| **总计** | **50-75 分钟** |
